<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeon Hospitals Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <style>
        :root {
            --background-color-light: #f9f9f9;
            --text-color-light: #1f1f1f;
            --control-background-light: #ffffff;
            --control-border-light: #ddd;
            --hover-background-light: #f1f1f1;
            --hyperlink-color: #00aaff;

            --background-color-dark: #2b2b2b;
            --text-color-dark: #f1f1f1;
            --control-background-dark: #333;
            --control-border-dark: #555;
            --hover-background-dark: #444;

            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color-light);
            color: var(--text-color-light);
            transition: background-color 0.3s, color 0.3s;
        }
    
        #map { height: 100%; width: 100%; }
    
        .controls {
            position: absolute;
            top: 10px;
            left: 60px;
            z-index: 1000;
            background: var(--control-background-light);
            color: var(--text-color-light);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            width: 220px;
            border: 1px solid var(--control-border-light);
        }

        .controls select, .controls input {
            margin-bottom: 10px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--control-border-light);
            background-color: var(--control-background-light);
            color: var(--text-color-light);
            font-size: 14px;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .controls select:focus, .controls input:focus {
            border-color: #007bff;
            outline: none;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            width: 100%;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
            accent-color: #007bff;
        }

        .checkbox-group span {
            font-size: 14px;
            line-height: 1.2;
            flex-grow: 1;
        }

        #hamburger, #legend-toggle, #theme-toggle {
            position: fixed;
            z-index: 1000;
            width: 40px;
            height: 40px;
            background: var(--control-background-light);
            color: var(--text-color-light);
            border: 1px solid var(--control-border-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }

        #hamburger {
                top: 85px;
                left: 8px;
        }

        #legend-toggle {
            bottom: 10px;
            left: 10px;
        }

        #theme-toggle {
            top: 10px;
            right: 10px;
        }

        .legend-container {
            position: fixed;
            bottom: 10px;
            left: 60px;
            z-index: 1001;
            background: var(--control-background-light);
            color: var(--text-color-light);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }

        .legend-container.open {
            display: block;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .chart-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--control-background-light);
            color: var(--text-color-light);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .gauge-wrapper {
            text-align: center;
            margin: 0 10px;
        }

        .gauge {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
        }

        .gauge-percentage {
            font-size: 14px;
            margin-top: 5px;
        }

        .gauge-label {
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Styles pour les tags de statut */
        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 5px;
            font-size: 12px;
            text-transform: uppercase;
            border-radius: 5px;
            color: white;
            cursor: pointer; /* Ajouter un curseur pointer pour indiquer que c'est cliquable */
        }

        /* Couleurs des tags */
        .status-deployed {
            background-color: #b0e2b5;
            color: #1e7b34;
        }

        .status-in-progress {
            background-color: #ffe5a0;
            color: #6e5002;
        }

        .status-signed {
            background-color: #9ecbff;
            color: #0056b3;
        }

        /* Styles des tags actifs */
        .status-tag.active {
            color: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
            opacity: 1;
        }

        .status-deployed.active {
            background-color: #28a745;
        }

        .status-in-progress.active {
            background-color: #ffc107;
            color: #856404;
        }

        .status-signed.active {
            background-color: #007bff;
        }

        body.dark-mode {
            background-color: var(--background-color-dark);
            color: var(--text-color-dark);
        }

        body.dark-mode .controls,
        body.dark-mode .controls select,
        body.dark-mode .controls input,
        body.dark-mode #hamburger,
        body.dark-mode #legend-toggle,
        body.dark-mode #theme-toggle,
        body.dark-mode .legend-container,
        body.dark-mode .chart-container,
        body.dark-mode .leaflet-control-zoom-in, 
        body.dark-mode .leaflet-control-zoom-out {
            background-color: var(--control-background-dark);
            color: var(--text-color-dark);
            border-color: var(--control-border-dark);
        }

        body.dark-mode #theme-toggle {
            color: yellow;
        }

        .leaflet-popup-content-wrapper {
            background-color: var(--control-background-light);
            color: var(--text-color-light);
            border-radius: 8px;
            padding: 0;
            border: none;
            box-shadow: 0 3px 14px rgba(0,0,0,0.2);
            max-width: 250px;
            width: 300px;
        }

        .leaflet-popup-content {
            margin: 0;
            padding: 15px;
            width: auto !important;
        }

        .leaflet-popup-tip-container {
            display: none;
        }

        .leaflet-tile-container img {
            box-shadow: none !important;
        }

        /* Styles du contenu du popup */
        .popup-content {
            text-align: center;
        }

        .popup-content .status-tag.active {
            opacity: 1;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .popup-image {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        .popup-content p {
            margin: 5px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 14px;
        }

        .popup-content a {
            color: var(--primary-color);
            text-decoration: none;
            word-break: break-all;
            font-size: 14px;
        }

        .popup-content a:hover {
            text-decoration: underline;
        }

        .leaflet-control-attribution {
            display: none;
        }

        /* Styles des popups pour le thème sombre */
        body.dark-mode .leaflet-popup-content-wrapper {
            background-color: var(--control-background-dark);
            color: var(--text-color-dark);
            border: none;
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }

        body.dark-mode .leaflet-popup-content {
            margin: 0;
            padding: 15px;
            width: auto !important;
        }

        body.dark-mode .leaflet-popup-tip-container {
            display: none;
        }

        body.dark-mode .leaflet-popup-close-button {
            color: var(--text-color-dark);
        }

        /* Ajuster pour mobile */
        @media (max-width: 768px) {
            .leaflet-popup-content-wrapper {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                max-width: 220px;
                padding: 5px;
                width: 300px;
            }
            .leaflet-popup-content h3 {
                font-size: 14px;
            }
            .leaflet-popup-content img {
                width: 100px;
            }
            .leaflet-popup-content p, .leaflet-popup-content a {
                font-size: 12px;
            }

            .leaflet-popup-tip {
                border: none !important;
                box-shadow: none !important;
            }
            .gauge {
                width: 60px;
                height: 60px;
            }
            .legend-container {
                bottom: 150px;
                left: 10px;
            }
            .chart-container {
                position: fixed;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                background: var(--control-background-light);
                color: var(--text-color-light);
                padding: 10px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                display: flex;
                justify-content: center;
                align-items: center;
                width: 300px;
            }
            #legend-toggle {
                top: 140px;
                left: 9px;
            }
            .controls {
                width: 180px;
                padding: 10px;
                font-size: 12px;
            }

            /* Style pour le statut */
            .status-tag {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 4px;
                margin: 5px;
                font-size: 12px;
                text-transform: uppercase;
            }

            .controls select, .controls input {
                font-size: 13px;
                padding: 5px;
            }
            .legend-item {
                margin-bottom: 3px;
            }
            .legend-color {
                width: 15px;
                height: 15px;
                margin-right: 5px;
            }
        }

        /* Supprimer les bordures et ombres non souhaitées */
        .leaflet-popup-content-wrapper::before, 
        .leaflet-popup-content-wrapper::after {
            content: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="hamburger">☰</button>
    <button id="legend-toggle"><i class="fas fa-info"></i></button>
    <div class="legend-container">
        <div class="legend-item"><span class="legend-color" style="background-color: green;"></span><span class="legend-text">Deployed</span></div>
        <div class="legend-item"><span class="legend-color" style="background-color: orange;"></span><span class="legend-text">In Progress</span></div>
        <div class="legend-item"><span class="legend-color" style="background-color: rgb(0, 140, 255);"></span><span class="legend-text">Signed</span></div>
    </div>
    <div class="controls">
        <select id="language-select">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="zh">中文</option>
            <option value="ar">العربية</option>
            <option value="hi">हिन्दी</option>
            <option value="bn">বাংলা</option>
            <option value="pt">Português</option>
            <option value="ru">Русский</option>
            <option value="ja">日本語</option>
            <option value="de">Deutsch</option>
            <option value="ko">한국어</option>
            <option value="vi">Tiếng Việt</option>
            <option value="tr">Türkçe</option>
            <option value="fa">فارسی</option>
            <option value="ur">اردو</option>
            <option value="it">Italiano</option>
            <option value="ta">தமிழ்</option>
            <option value="pl">Polski</option>
            <option value="nl">Nederlands</option>
        </select>
        <select id="continent-select">
            <option value="">Continent</option>
            <option value="Europe">Europe</option>
            <option value="North America">North America</option>
            <option value="South America">South America</option>
            <option value="Asia">Asia</option>
            <option value="Africa">Africa</option>
            <option value="Oceania">Oceania</option>
        </select>
        <input type="text" id="country-filter" placeholder="Enter country...">
        <input type="text" id="city-filter" placeholder="Enter city...">
        <div class="status-filters">
            <span class="status-tag status-deployed" data-status="deployed">Deployed</span>
            <span class="status-tag status-in-progress" data-status="in progress">In Progress</span>
            <span class="status-tag status-signed" data-status="signed">Signed</span>
        </div>        
    </div>
    <div class="chart-container">
        <div class="gauge-wrapper">
            <div id="deployed-progress" class="gauge">
                <div class="gauge-value"></div>
            </div>
            <div class="gauge-percentage"></div>
            <div class="gauge-label">Deployed</div>
        </div>
        <div class="gauge-wrapper">
            <div id="in-progress-progress" class="gauge">
                <div class="gauge-value"></div>
            </div>
            <div class="gauge-percentage"></div>
            <div class="gauge-label">In Progress</div>
        </div>
        <div class="gauge-wrapper">
            <div id="signed-progress" class="gauge">
                <div class="gauge-value"></div>
            </div>
            <div class="gauge-percentage"></div>
            <div class="gauge-label">Signed</div>
        </div>
    </div>
    <button id="theme-toggle"><i class="fas fa-moon"></i></button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script src="translations.js"></script>
    <script src="hospitals.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initApplication();
        });
    </script>
    <script>
        let map, markers = [], activeStatus = [], language = "en";
        let darkMode = false;
        let isMapInitialized = false;
        let isChartInitialized = false;
        let markerClusterGroup;
        let t = {}; // translations
        let isApplicationInitialized = false;

        const gauges = {};
        const colors = {
            'Deployed': '#4CAF50',
            'In Progress': '#FFA500',
            'Signed': '#2196F3'
        };


        function savePreferences() {
            const preferences = {
                theme: darkMode ? 'dark' : 'light',
                language: document.getElementById('language-select').value,
                continent: document.getElementById('continent-select').value,
                country: document.getElementById('country-filter').value,
                city: document.getElementById('city-filter').value,
                activeStatus: activeStatus
            };
            localStorage.setItem('galeonMapPreferences', JSON.stringify(preferences));
        }

        function loadPreferences() {
            const savedPreferences = localStorage.getItem('galeonMapPreferences');
            if (savedPreferences) {
                const preferences = JSON.parse(savedPreferences);
                const language = preferences.language || 'en';
                document.getElementById('language-select').value = language;
                
                darkMode = preferences.theme === 'dark';
                document.body.classList.toggle('dark-mode', darkMode);
                updateTileLayer();

                document.getElementById('continent-select').value = preferences.continent || '';
                document.getElementById('country-filter').value = preferences.country || '';
                document.getElementById('city-filter').value = preferences.city || '';

                // Réinitialiser l'état actif des tags de statut
                activeStatus = preferences.activeStatus || [];
                
                // Appliquer les traductions après avoir chargé les préférences
                applyTranslations(language);
            } else {
                // Si aucune préférence n'est sauvegardée, appliquer les traductions par défaut
                const defaultLanguage = document.getElementById('language-select').value;
                applyTranslations(defaultLanguage);
            }
        }

        function updateStatusTags(translations) {
            console.log("Updating status tags with translations:", translations);
            if (!translations || typeof translations !== 'object' || Object.keys(translations).length === 0) {
                console.error("Invalid translations object");
                return;
            }
            const statusTags = document.querySelectorAll('.status-tag');
            console.log(`Found ${statusTags.length} status tags`);
            statusTags.forEach(tag => {
                let status = tag.dataset.status ? tag.dataset.status.toLowerCase() : null;

                // Si le statut n'est pas défini, essayez de le déduire à partir du texte ou des classes
                if (!status) {
                    if (tag.classList.contains('status-deployed')) status = 'deployed';
                    else if (tag.classList.contains('status-in-progress')) status = 'in progress';
                    else if (tag.classList.contains('status-signed')) status = 'signed';
                    else status = tag.textContent.toLowerCase();

                    // Mettre à jour l'attribut data-status
                    tag.dataset.status = status;
                }

                // Mise à jour des traductions
                let translatedText;
                switch (status) {
                    case 'deployed':
                        translatedText = translations.deployed || translations.statusDeployed || 'Deployed';
                        break;
                    case 'in progress':
                        translatedText = translations.inProgress || translations.statusInProgress || 'In Progress';
                        break;
                    case 'signed':
                        translatedText = translations.signed || translations.statusSigned || 'Signed';
                        break;
                    default:
                        translatedText = status;
                }
                
                console.log(`Translating status '${status}' to '${translatedText}'`);
                tag.textContent = translatedText;

                // Vérification de l'état actif ou inactif
                if (activeStatus.includes(status)) {
                    tag.classList.add('active');
                } else {
                    tag.classList.remove('active');
                }
            });
        }

        function initApplication() {
            if (isApplicationInitialized) {
                console.log("Application already initialized, skipping...");
                return;
            }

            console.log("Initializing application...");
            initMap();
            initGauges();
            loadPreferences();

            isApplicationInitialized = true;
        }

        function initMap() {
            console.log("Initializing map...");
            if (!isMapInitialized) {
                map = L.map('map', {
                    center: [50, 10],
                    zoom: 4,
                    maxZoom: 18
                });

                markerClusterGroup = L.markerClusterGroup({
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true
                });

                map.addLayer(markerClusterGroup);
                isMapInitialized = true;
                updateTileLayer();
            } else {
                console.log("Map already initialized, skipping...");
            }
        }

        function initGauges() {
            console.log("Initializing gauges...");
            ['Deployed', 'In Progress', 'Signed'].forEach(status => {
                const element = document.getElementById(`${status.toLowerCase().replace(' ', '-')}-progress`);
                if (element) {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("viewBox", "0 0 36 36");
                    svg.innerHTML = `
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#eee"
                            stroke-width="3"
                        />
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="${colors[status]}"
                            stroke-width="3"
                            stroke-dasharray="0, 100"
                        />
                    `;
                    element.innerHTML = '';
                    element.appendChild(svg);

                    const valueContainer = document.createElement('div');
                    valueContainer.classList.add('gauge-value');
                    valueContainer.textContent = '0';
                    element.appendChild(valueContainer);

                    gauges[status] = {
                        path: svg.querySelector(`path[stroke="${colors[status]}"]`),
                        element: element
                    };
                }
            });
            isChartInitialized = true;
        }

        function updateGauges() {
            if (!isChartInitialized) {
                console.warn("Charts not initialized, skipping gauge update");
                return;
            }

            const statusCounts = hospitals.reduce((acc, hospital) => {
                acc[hospital.status] = (acc[hospital.status] || 0) + 1;
                return acc;
            }, {});

            const totalHospitals = hospitals.length;

            ['Deployed', 'In Progress', 'Signed'].forEach(status => {
                const count = statusCounts[status] || 0;
                const percentage = (count / totalHospitals) * 100 || 0;

                if (gauges[status]) {
                    gauges[status].path.setAttribute("stroke-dasharray", `${percentage}, 100`);

                    const valueElement = gauges[status].element.querySelector('.gauge-value');
                    if (valueElement) {
                        valueElement.textContent = count;
                    }

                    const percentageElement = gauges[status].element.nextElementSibling;
                    if (percentageElement) {
                        percentageElement.textContent = `(${percentage.toFixed(1)}%)`;
                    }
                }
            });
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            updateTileLayer();
            savePreferences();
        }

        function updateTileLayer() {
            if (window.currentTileLayer && map.hasLayer(window.currentTileLayer)) {
                map.removeLayer(window.currentTileLayer);
            }

            window.currentTileLayer = L.tileLayer(
                darkMode
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                {
                    maxZoom: 19
                }
            ).addTo(map);
        }

        function filterHospitals(status) {
            if (!status) return;
            const tagElement = document.querySelector(`.status-tag[data-status="${status}"]`);
            if (!tagElement) return;

            // Mettre à jour l'attribut data-status si nécessaire
            if (!tagElement.dataset.status) {
                tagElement.dataset.status = status.toLowerCase();
            }

            if (activeStatus.includes(status)) {
                activeStatus = activeStatus.filter(s => s !== status);
                tagElement.classList.remove('active');
            } else {
                activeStatus.push(status);
                tagElement.classList.add('active');
            }

            addMarkers();
            savePreferences();
        }

        function extractLocationInfo(address) {
            const parts = address.split(',').map(part => part.trim());
            return {
                city: parts[parts.length - 2] || '',
                country: parts[parts.length - 1] || ''
            };
        }

        function normalizeString(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function addMarkers() {
            console.log("Updating markers...");

            const selectedContinent = document.getElementById('continent-select').value;
            const selectedCountry = document.getElementById('country-filter').value.toLowerCase();
            const selectedCity = document.getElementById('city-filter').value.toLowerCase();
            const selectedLanguage = document.getElementById('language-select').value;
            const currentTranslations = translations[selectedLanguage] || translations['en'];

            // Sauvegarder la position de la popup active, s'il y en a une
            let openPopupLatLng = null;
            let openPopupContent = null;

            if (map && map._popup && map._popup._latlng) {
                openPopupLatLng = map._popup._latlng;
                openPopupContent = map._popup.getContent();
            }

            markerClusterGroup.clearLayers();
            markers = [];

            let filteredCount = 0;

            hospitals.forEach((hospital) => {
                const { city, country } = extractLocationInfo(hospital.address);

                const statusMatch = activeStatus.length === 0 || activeStatus.includes(hospital.status.toLowerCase());
                const continentMatch = !selectedContinent || getContinent(hospital.lat, hospital.lon) === selectedContinent;
                const countryMatch = !selectedCountry || country.toLowerCase().includes(selectedCountry);
                const cityMatch = !selectedCity || city.toLowerCase().includes(selectedCity);

                if (statusMatch && continentMatch && countryMatch && cityMatch) {
                    const marker = L.circleMarker([hospital.lat, hospital.lon], {
                        radius: 8,
                        fillColor: getColor(hospital.status),
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    marker.hospitalData = hospital;
                    updateMarkerContent(marker, hospital, currentTranslations);
                    markerClusterGroup.addLayer(marker);
                    markers.push(marker);
                    filteredCount++;
                }
            });

            // Restaurer la popup si elle était ouverte
            if (openPopupLatLng) {
                markers.forEach(marker => {
                    if (marker.getLatLng().equals(openPopupLatLng)) {
                        marker.bindPopup(openPopupContent).openPopup();
                    }
                });
            }

            logFilterStatus(selectedContinent, selectedCountry, selectedCity, activeStatus, filteredCount, hospitals.length);
            updateGauges();
        }

        function logFilterStatus(continent, country, city, activeStatuses, filteredCount, totalCount) {
            console.log(`Filter Status:
            Continent: ${continent || 'All'}
            Country: ${country || 'All'}
            City: ${city || 'All'}
            Active Statuses: ${activeStatuses.length > 0 ? activeStatuses.join(', ') : 'All'}
            Markers Displayed: ${filteredCount} out of ${totalCount}
            `);
        }

        function updateMarkerContent(marker, hospital, translations) {
            const statusTag = getStatusTag(hospital.status, translations, true);
            const popupContent = `
                <div class="popup-content">
                    <h3 class="popup-title" style="color: #00aaff;">${hospital.name}</h3>
                    <img class="popup-image" src="${hospital.imageUrl}" alt="${hospital.name}">
                    <p><strong>${translations.address}:</strong><br>${hospital.address}</p>
                    <p><a href="${hospital.website}" target="_blank" style="color: var(--hyperlink-color); font-size: 1.2em;">${translations.visitWebsite}</a></p>
                    <p><strong>${translations.status}:</strong> ${statusTag}</p>
                </div>
            `;

            if (marker.getPopup()) {
                marker.getPopup().setContent(popupContent);
            } else {
                marker.bindPopup(popupContent);
            }
        }

        function getContinent(lat, lon) {
            if (lat >= 40 && lon >= -10 && lon <= 60) return "Europe";
            if (lat <= 40 && lat >= -40 && lon >= -10 && lon <= 60) return "Africa";
            // Ajoutez ici la logique pour les autres continents
            return "Unknown";
        }

        function getColor(status) {
            switch (status) {
                case 'Deployed':
                    return '#28a745';
                case 'In Progress':
                    return '#ffc107';
                case 'Signed':
                    return '#007bff';
                default:
                    return '#6c757d';
            }
        }

        function getStatusTag(status, translations, isActive = false) {
            const statusKey = status.toLowerCase().replace(" ", "");
            const statusText = translations[statusKey] || status;
            const activeClass = isActive ? ' active' : '';
            
            switch (status) {
                case 'Signed':
                    return `<span class="status-tag status-signed${activeClass}">${statusText}</span>`;
                case 'Deployed':
                    return `<span class="status-tag status-deployed${activeClass}">${statusText}</span>`;
                case 'In Progress':
                    return `<span class="status-tag status-in-progress${activeClass}">${statusText}</span>`;
                default:
                    return `<span class="status-tag${activeClass}">Unknown</span>`;
            }
        };

        function toggleLegend() {
            const legendContainer = document.querySelector('.legend-container');
            const isVisible = legendContainer.style.display !== 'none';
            legendContainer.style.display = isVisible ? 'none' : 'block';
        }

        function toggleMenu() {
            const controls = document.querySelector('.controls');
            controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
        }

        function adjustForMobile() {
            const isMobile = window.innerWidth <= 767;
            const isPortrait = window.innerHeight > window.innerWidth;
            const legendContainer = document.querySelector('.legend-container');
            const chartContainer = document.querySelector('.chart-container');

            if (isMobile && isPortrait) {
                legendContainer.style.display = 'none';
                chartContainer.style.flexDirection = 'row';
            } else {
                legendContainer.style.display = 'block';
                chartContainer.style.flexDirection = 'row';
            }
        }

        function applyTranslations(language) {
            console.log(`Applying translations for language: ${language}`);
            const t = translations[language] || translations['en'];
            console.log("Translation object:", t);

            if (!t || typeof t !== 'object' || Object.keys(t).length === 0) {
                console.error(`Invalid translations found for language: ${language}`);
                return;
            }

            // Mise à jour des placeholders
            const countryFilter = document.getElementById('country-filter');
            const cityFilter = document.getElementById('city-filter');
            if (countryFilter) countryFilter.setAttribute('placeholder', t.enterCountry || 'Enter country...');
            if (cityFilter) cityFilter.setAttribute('placeholder', t.enterCity || 'Enter city...');

            // Mise à jour de la légende
            const legendItems = document.querySelectorAll('.legend-item .legend-text');
            console.log(`Found ${legendItems.length} legend items`);
            if (legendItems.length >= 3) {
                legendItems[0].textContent = t.legendDeployed || 'Deployed';
                legendItems[1].textContent = t.legendInProgress || 'In Progress';
                legendItems[2].textContent = t.legendSigned || 'Signed';
            } else {
                console.warn("Not enough legend items found");
            }

            // Mise à jour du select pour le continent
            const continentSelect = document.getElementById('continent-select');
            if (continentSelect) {
                continentSelect.options[0].text = t.continent || 'Continent';
                // Mise à jour des options des continents
                const continentOptions = {
                    'Europe': t.europe || 'Europe',
                    'North America': t.northAmerica || 'North America',
                    'South America': t.southAmerica || 'South America',
                    'Asia': t.asia || 'Asia',
                    'Africa': t.africa || 'Africa',
                    'Oceania': t.oceania || 'Oceania'
                };
                for (let i = 1; i < continentSelect.options.length; i++) {
                    const option = continentSelect.options[i];
                    option.text = continentOptions[option.value] || option.value;
                }
            } else {
                console.warn("Continent select not found");
            }

            // Mise à jour des jauges
            const gaugeLabels = document.querySelectorAll('.gauge-label');
            console.log(`Found ${gaugeLabels.length} gauge labels`);
            if (gaugeLabels.length >= 3) {
                gaugeLabels[0].textContent = t.gaugesDeployed || 'Deployed';
                gaugeLabels[1].textContent = t.gaugesInProgress || 'In Progress';
                gaugeLabels[2].textContent = t.gaugesSigned || 'Signed';
            } else {
                console.warn("Not enough gauge labels found");
            }

            // Mise à jour des balises de statut (tags) de la page
            updateStatusTags(t);

            // Mise à jour des marqueurs
            if (markerClusterGroup) {
                updateMarkersContent(t);
            } else {
                console.warn("markerClusterGroup is not initialized yet.");
            }

            // Ajouter les marqueurs après avoir appliqué les traductions
            addMarkers();
        }

        function updateMarkersContent(translations) {
            markerClusterGroup.eachLayer((layer) => {
                if (layer instanceof L.CircleMarker && layer.hospitalData) {
                    const popupContent = createPopupContent(layer.hospitalData, translations);
                    if (layer.getPopup()) {
                        layer.getPopup().setContent(popupContent);
                    } else {
                        layer.bindPopup(popupContent);
                    }
                }
            });
        }
    

        function createPopupContent(hospital, translations) {
            const statusTag = getStatusTag(hospital.status, translations, true);
            return `
                <div class="popup-content">
                    <h3 class="popup-title" style="color: #00aaff;">${hospital.name}</h3>
                    <img class="popup-image" src="${hospital.imageUrl}" alt="${hospital.name}">
                    <p><strong>${translations.address}:</strong><br>${hospital.address}</p>
                    <p><a href="${hospital.website}" target="_blank" style="color: var(--hyperlink-color); font-size: 1.2em;">${translations.visitWebsite}</a></p>
                    <p><strong>${translations.status}:</strong> ${statusTag}</p>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded");
            initApplication();

            const filterInputs = document.querySelectorAll('#country-filter, #city-filter');
            filterInputs.forEach(input => {
                input.addEventListener('input', debounce(() => {
                    addMarkers();
                    savePreferences();
                }, 300));
            });

            document.getElementById('language-select').addEventListener('change', function() {
                const selectedLanguage = this.value;
                console.log(`Language changed to: ${selectedLanguage}`);
                applyTranslations(selectedLanguage);
                savePreferences();
            });

            document.getElementById('continent-select').addEventListener('change', function() {
                addMarkers();
                savePreferences();
            });

            document.querySelectorAll('.status-tag').forEach(tag => {
                tag.addEventListener('click', (e) => {
                    const status = e.target.dataset.status;
                    if (status) {
                        filterHospitals(status);
                    }
                });
            });

            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('hamburger').addEventListener('click', toggleMenu);
            document.getElementById('legend-toggle').addEventListener('click', toggleLegend);
            
            window.addEventListener('load', adjustForMobile);
            window.addEventListener('resize', adjustForMobile);
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function checkTranslations() {
            console.log("Checking translations structure:");
            for (const lang in translations) {
                console.log(`Language: ${lang}`);
                console.log(translations[lang]);
            }
        }

        document.addEventListener('DOMContentLoaded', checkTranslations);
    </script>
</body>
</html>